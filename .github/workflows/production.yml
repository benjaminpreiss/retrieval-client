name: Production CI/CD
on:
  push:
    tags:
      - production/*
env:
  # How to sync these vars with other repos?
  AWS_ACCESS_KEY_ID: ${{ secrets.PROD_GITHUB_CI_AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.PROD_GITHUB_CI_AWS_SECRET_ACCESS_KEY }}
  AWS_ACCOUNT_ID: ${{ secrets.PROD_AWS_ACCOUNT_NUMBER }}
  AWS_REGION: us-west-1
  ROOT_DOMAIN: strn.network
  BUCKET: filecoin-saturn
jobs:
  cicd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: master

      - uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{env.AWS_REGION}}

      - name: Build and Push Assets
        env:
          STATIC_ORIGIN: https://${{env.ROOT_DOMAIN}}
          GATEWAY_ORIGIN: https://cdn.${{env.ROOT_DOMAIN}}
        run: |
          npm ci --also=dev
          npm run build

          aws s3 cp dist/ s3://$BUCKET --recursive \
            --cache-control "public, max-age=3600" --only-show-errors
